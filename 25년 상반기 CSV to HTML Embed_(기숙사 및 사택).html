<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV to HTML Converter</title>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 20px;
            padding: 20px;
            background: #f0f2f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1a237e;
            text-align: center;
            margin-bottom: 30px;
        }
        .file-input {
            margin-bottom: 20px;
        }
        .file-input label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: bold;
        }
        .file-input input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #1a237e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: block;
            margin: 20px auto;
        }
        button:hover {
            background: #283593;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        #preview {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        /* Hide preprocessing UI elements */
        #controls,
        #preprocessing-log,
        #message {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CSV to HTML Converter</h1>
        <div class="file-input">
            <label for="html-template">HTML 템플릿 파일 선택:</label>
            <input type="file" id="html-template" accept=".html">
        </div>
        <div class="file-input">
            <label for="csv-file">CSV 파일 선택:</label>
            <input type="file" id="csv-file" accept=".csv">
        </div>
        <button id="convert">변환하기</button>
        <div id="status"></div>
        <div id="preview"></div>
    </div>

    <script>
        let processedHtmlTemplate = null;

        document.getElementById('html-template').addEventListener('change', async function(e) {
            const htmlFile = e.target.files[0];
            if (!htmlFile) return;

            try {
                const htmlContent = await readFile(htmlFile);
                processedHtmlTemplate = htmlContent;
                showStatus('HTML 템플릿이 준비되었습니다. CSV 파일을 선택해주세요.', 'success');
            } catch (error) {
                showStatus('HTML 템플릿 처리 중 오류가 발생했습니다: ' + error.message, 'error');
            }
        });

        document.getElementById('convert').addEventListener('click', async function() {
            const csvFile = document.getElementById('csv-file').files[0];
            const status = document.getElementById('status');
            const preview = document.getElementById('preview');

            if (!processedHtmlTemplate) {
                showStatus('먼저 HTML 템플릿을 선택해주세요.', 'error');
                return;
            }

            if (!csvFile) {
                showStatus('CSV 파일을 선택해주세요.', 'error');
                return;
            }

            try {
                const csvContent = await readFile(csvFile);
                const processedData = processCSV(csvContent);
                const newHtml = createNewHTML(processedHtmlTemplate, processedData);
                
                // 파일명 생성
                const csvFileName = csvFile.name.replace('.csv', '');
                const currentDate = new Date().toISOString().split('T')[0];
                const outputFileName = `${csvFileName}_${currentDate}.html`;
                
                // showSaveFilePicker를 사용하여 파일 저장
                const blob = new Blob([newHtml], { type: 'text/html' });
                const handle = await window.showSaveFilePicker({
                    suggestedName: outputFileName,
                    types: [{
                        description: 'HTML 파일',
                        accept: {
                            'text/html': ['.html']
                        }
                    }]
                });
                
                const writable = await handle.createWritable();
                await writable.write(blob);
                await writable.close();
                
                showStatus('변환이 완료되었습니다!', 'success');
                showPreview(processedData);
            } catch (error) {
                if (error.name === 'AbortError') {
                    showStatus('파일 저장이 취소되었습니다.', 'error');
                } else {
                    showStatus('오류가 발생했습니다: ' + error.message, 'error');
                }
            }
        });

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('파일 읽기 실패'));
                reader.readAsText(file);
            });
        }

        function processCSV(csvContent) {
            const rows = d3.csvParse(csvContent);
            if (!rows || rows.length === 0) {
                throw new Error('CSV 파일이 비어있거나 올바른 형식이 아닙니다.');
            }

            const requiredColumns = ['월', '작업유형', '절감항목', 'A.집행비', 'B.공사비 적용시', '절감비(A-B)'];
            const missingColumns = requiredColumns.filter(col => !rows[0].hasOwnProperty(col));
            if (missingColumns.length > 0) {
                throw new Error(`필수 컬럼이 누락되었습니다: ${missingColumns.join(', ')}`);
            }

            // 숫자 포맷팅 함수 추가
            function formatNumberWithCommas(str) {
                if (/^-?\d+$/.test(str)) {
                    return str.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                }
                return str.replace(/(\d{3,})/g, function(match) {
                    return match.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                });
            }

            const processedData = [];
            rows.forEach(row => {
                const month = (row['월'] || '').trim();
                const type = (row['작업유형'] || '').trim();
                const detail = (row['절감항목'] || '').trim();
                const note = (row['비고'] || '').trim();

                const formattedMonth = month.replace(/(\d{4})-(\d{2})-\d{2}/, '$1-$2');
                
                const cleanNumber = (value) => {
                    if (!value || value.trim() === '') return 0;
                    return parseFloat(value.toString().replace(/,/g, '')) || 0;
                };

                const actual = cleanNumber(row['A.집행비']);
                const estimated = cleanNumber(row['B.공사비 적용시']);
                const saving = cleanNumber(row['절감비(A-B)']);

                if (formattedMonth && type && detail) {
                    processedData.push({
                        month: formattedMonth,
                        type: type,
                        detail: formatNumberWithCommas(detail),
                        actual: actual,
                        estimated: estimated,
                        saving: saving,
                        note: formatNumberWithCommas(note)
                    });
                }
            });

            // 데이터 정렬 최적화
            processedData.sort((a, b) => {
                if (a.month !== b.month) return a.month.localeCompare(b.month);
                if (a.type !== b.type) return a.type.localeCompare(b.type);
                return a.detail.localeCompare(b.detail);
            });

            return processedData;
        }

        function createNewHTML(htmlContent, processedData) {
            const dataVarRegex = /let\s+allData\s*=\s*\[([\s\S]*?)\];/;
            const jsonData = JSON.stringify(processedData, null, 2)
                .replace(/\n/g, '\n      ');
            
            // HTML 템플릿 재구성
            const templateReconstruction = `
    // HTML 템플릿 재구성
    function reconstructTemplate(html) {
        // 1. 전처리 로그와 파일 선택 관련 코드 제거
        const codePatterns = [
            // 함수 정의 제거
            /function\s+(initPreprocessingLog|addPreprocessingStep|showPreprocessingLog|handleFileSelect|loadData|handleFileUpload)\([^}]*\}/g,
            // 이벤트 리스너 제거
            /document\.(getElementById|querySelector)\(['"](file-input|csv-input|preprocessing-log|controls|message)['"]\)\.addEventListener\([^}]*\}/g,
            // HTML 요소 제거
            /<div[^>]*(id|class)=['"](controls|message|preprocessing-log|preprocessing-steps|file-upload|preprocessing-log|log-message|file-select|upload-controls)['"][^>]*>.*?<\/div>/gs,
            /<input[^>]*(id|class)=['"](file-input|csv-input)['"][^>]*>/g,
            // 스타일 정의 제거
            /#(preprocessing-log|controls|message|file-input|csv-input)\s*{[^}]*}/g,
            /\.(file-upload|preprocessing-log|log-message|file-select|upload-controls)\s*{[^}]*}/g
        ];
        
        codePatterns.forEach(pattern => {
            html = html.replace(pattern, '');
        });
        
        // 2. 대시보드 컨테이너 수정
        html = html.replace(
            /<div[^>]*id=['"]dashboard-container['"][^>]*>/,
            '<div id="dashboard-container" style="margin-top: 80px !important; display: flex; justify-content: flex-start; align-items: flex-start; gap: 20px; padding: 20px; flex-wrap: nowrap; position: relative; width: 100%; box-sizing: border-box; min-height: calc(100vh - 100px); overflow: visible;">'
        );
        
        // 3. 제목 수정
        html = html.replace(
            /<h1[^>]*>/,
            '<h1 style="margin-bottom: 20px !important; text-align: center; color: #1a237e; font-size: 32px; margin-bottom: 2px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); position: fixed; top: 0; left: 0; right: 0; background: #f0f2f5; padding: 15px; z-index: 1000; font-weight: 700; letter-spacing: 0.5px; border-bottom: 2px solid #1a237e; width: 100%; box-sizing: border-box;">'
        );

        // 4. 차트 컨테이너 스타일 추가
        html = html.replace(
            /<div[^>]*id=['"]chart-container['"][^>]*>/,
            '<div id="chart-container" style="width: 30%; max-width: 500px; height: calc(100vh - 200px); aspect-ratio: 1; flex-shrink: 0; display: flex; align-items: center; justify-content: center; overflow: visible; margin-left: 0; padding-left: 0; position: relative; box-sizing: border-box;">'
        );

        // 5. 테이블 컨테이너 스타일 추가
        html = html.replace(
            /<div[^>]*id=['"]table-container['"][^>]*>/,
            '<div id="table-container" style="width: 70%; max-width: 1000px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); font-size: 13px; height: calc(100vh - 200px); overflow: auto; position: relative; flex-shrink: 0; box-sizing: border-box; margin-left: 0;">'
        );
        
        return html;
    }
    
    // HTML 템플릿 재구성 실행
    const reconstructedHtml = reconstructTemplate(htmlContent);
    
    // 데이터 변수 교체 및 즉시 실행 코드 추가
    return reconstructedHtml.replace(dataVarRegex, \`let allData = \${jsonData};
    
    // 즉시 실행 함수로 초기화 코드 추가
    (function() {
        // 초기화 함수
        function initializeDashboard() {
            if (allData && allData.length > 0) {
                initChart();
                drawChart();
                updateTable();
                updateMonthFilter();
            }
        }

        // DOM이 완전히 로드된 후 실행
        if (document.readyState === 'complete') {
            setTimeout(initializeDashboard, 100);
        } else {
            window.addEventListener('load', function() {
                setTimeout(initializeDashboard, 100);
            });
        }
    })();\`);
`;

            return htmlContent.replace(dataVarRegex, `let allData = ${jsonData};
            
            // 즉시 실행 함수로 초기화 코드 추가
            (function() {
                // 초기화 함수
                function initializeDashboard() {
                    if (allData && allData.length > 0) {
                        initChart();
                        drawChart();
                        updateTable();
                        updateMonthFilter();
                    }
                }

                // DOM이 완전히 로드된 후 실행
                if (document.readyState === 'complete') {
                    setTimeout(initializeDashboard, 100);
                } else {
                    window.addEventListener('load', function() {
                        setTimeout(initializeDashboard, 100);
                    });
                }
            })();`);
        }

        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        function showPreview(data) {
            const preview = document.getElementById('preview');
            
            // 데이터 통계 계산
            const totalSaving = Math.floor(data.reduce((sum, row) => sum + row.saving, 0));
            const uniqueTypes = [...new Set(data.map(row => row.type))];
            const months = [...new Set(data.map(row => row.month))];
            
            // 작업유형별 통계 계산
            const typeStats = {};
            data.forEach(row => {
                if (!typeStats[row.type]) {
                    typeStats[row.type] = {
                        count: 0,
                        totalSaving: 0,
                        avgSaving: 0,
                        items: []
                    };
                }
                typeStats[row.type].count++;
                typeStats[row.type].totalSaving += row.saving;
                typeStats[row.type].items.push(row);
            });

            // 작업유형별 평균 절감액 계산
            Object.keys(typeStats).forEach(type => {
                typeStats[type].avgSaving = Math.floor(typeStats[type].totalSaving / typeStats[type].count);
            });

            // 작업유형별 절감액 계산
            const savingsByType = {};
            data.forEach(row => {
                savingsByType[row.type] = Math.floor((savingsByType[row.type] || 0) + row.saving);
            });
            
            // 최대 절감액 항목 찾기 (0원 제외)
            const nonZeroData = data.filter(row => row.saving > 0);
            const maxSavingItem = nonZeroData.length > 0
                ? nonZeroData.reduce((max, row) => row.saving > max.saving ? row : max, { saving: -Infinity })
                : { saving: 0, detail: '절감액이 있는 데이터가 없습니다' };
            
            // 월별 평균 절감액 계산
            const monthlyAverages = {};
            months.forEach(month => {
                const monthData = data.filter(row => row.month === month);
                monthlyAverages[month] = Math.floor(monthData.reduce((sum, row) => sum + row.saving, 0) / monthData.length);
            });
            
            preview.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h3 style="color: #1a237e; margin-bottom: 20px; text-align: center;">데이터 분석 요약</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 6px;">
                            <h4 style="margin: 0 0 10px 0; color: #333;">기본 정보</h4>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li>총 데이터 건수: ${data.length}건</li>
                                <li>작업유형 수: ${uniqueTypes.length}개</li>
                                <li>데이터 기간: ${months[0]} ~ ${months[months.length-1]}</li>
                                <li>총 절감액: ${totalSaving.toLocaleString()}원</li>
                            </ul>
                        </div>
                        
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 6px;">
                            <h4 style="margin: 0 0 10px 0; color: #333;">작업 유형별 분석</h4>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li>가장 빈번한 작업: ${Object.entries(typeStats)
                                    .sort((a, b) => b[1].count - a[1].count)[0][0]} (${Object.entries(typeStats)
                                    .sort((a, b) => b[1].count - a[1].count)[0][1].count}건)</li>
                                <li>최고 절감 작업: ${Object.entries(typeStats)
                                    .sort((a, b) => b[1].totalSaving - a[1].totalSaving)[0][0]} (${Object.entries(typeStats)
                                    .sort((a, b) => b[1].totalSaving - a[1].totalSaving)[0][1].totalSaving.toLocaleString()}원)</li>
                                <li>평균 절감액 최고: ${Object.entries(typeStats)
                                    .sort((a, b) => b[1].avgSaving - a[1].avgSaving)[0][0]} (${Object.entries(typeStats)
                                    .sort((a, b) => b[1].avgSaving - a[1].avgSaving)[0][1].avgSaving.toLocaleString()}원)</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">작업유형별 절감액</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                            ${Object.entries(savingsByType)
                                .sort((a, b) => b[1] - a[1])
                                .map(([type, saving]) => `
                                    <div style="background: #e3f2fd; padding: 10px; border-radius: 4px;">
                                        <div style="font-weight: bold;">${type}</div>
                                        <div>${saving.toLocaleString()}원</div>
                                        <div style="font-size: 0.9em; color: #666;">${typeStats[type].count}건</div>
                                    </div>
                                `).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #333;">월별 평균 절감액</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                            ${Object.entries(monthlyAverages)
                                .map(([month, average]) => `
                                    <div style="background: #e8f5e9; padding: 10px; border-radius: 4px;">
                                        <div style="font-weight: bold;">${month}</div>
                                        <div>${average.toLocaleString()}원</div>
                                    </div>
                                `).join('')}
                        </div>
                    </div>
                </div>
            `;
            preview.style.display = 'block';
        }
    </script>
    <script src="https://d3js.org/d3.v6.min.js"></script>
</body>
</html> 